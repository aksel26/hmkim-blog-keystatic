name: Send Newsletter on New Post

on:
  push:
    branches: [main]
    paths:
      - 'apps/blog/content/**/*.mdoc'
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - 'apps/blog/content/**/*.mdoc'

jobs:
  send-newsletter:
    # push 이벤트이거나, PR이 merge된 경우에만 실행
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get added mdoc files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/blog/content/**/*.mdoc

      - name: Setup Node.js
        if: steps.changed-files.outputs.added_files != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract post info and send newsletter
        if: steps.changed-files.outputs.added_files != ''
        env:
          NEWSLETTER_API_KEY: ${{ secrets.NEWSLETTER_API_KEY }}
          AGENT_WEB_URL: ${{ vars.AGENT_WEB_URL }}
          BLOG_URL: ${{ vars.BLOG_URL }}
        run: |
          # 첫 번째 추가된 파일 처리
          FILE="${{ steps.changed-files.outputs.added_files }}"
          FIRST_FILE=$(echo "$FILE" | cut -d' ' -f1)

          if [ -z "$FIRST_FILE" ]; then
            echo "No new mdoc files found"
            exit 0
          fi

          echo "Processing file: $FIRST_FILE"

          # 파일에서 frontmatter 추출
          CONTENT=$(cat "$FIRST_FILE")

          # 포스트 상태 체크 - published가 아니면 스킵
          STATUS=$(echo "$CONTENT" | grep -m1 "^status:" | sed 's/status: *//' | tr -d '"' | tr -d "'")
          echo "Post status: $STATUS"

          if [ "$STATUS" != "published" ]; then
            echo "Post is not published (status: $STATUS), skipping newsletter"
            exit 0
          fi

          # YAML frontmatter에서 title, summary, thumbnailImage 추출
          TITLE=$(echo "$CONTENT" | grep -m1 "^title:" | sed 's/title: *//' | tr -d '"' | tr -d "'")
          SUMMARY=$(echo "$CONTENT" | grep -m1 "^summary:" | sed 's/summary: *//' | tr -d '"' | tr -d "'")
          THUMBNAIL_PATH=$(echo "$CONTENT" | grep -m1 "^thumbnailImage:" | sed 's/thumbnailImage: *//' | tr -d '"' | tr -d "'")

          # 카테고리와 슬러그 추출
          if [[ "$FIRST_FILE" == *"/tech/"* ]]; then
            CATEGORY="tech"
          else
            CATEGORY="life"
          fi

          SLUG=$(basename "$FIRST_FILE" .mdoc)
          POST_URL="${BLOG_URL}/${CATEGORY}/${SLUG}"

          # 썸네일 URL 생성 (경로가 있는 경우)
          if [ -n "$THUMBNAIL_PATH" ]; then
            THUMBNAIL_URL="${BLOG_URL}${THUMBNAIL_PATH}"
          else
            THUMBNAIL_URL=""
          fi

          echo "Title: $TITLE"
          echo "Summary: $SUMMARY"
          echo "URL: $POST_URL"
          echo "Thumbnail: $THUMBNAIL_URL"

          # 뉴스레터 발송 API 호출
          if [ -n "$TITLE" ] && [ -n "$SUMMARY" ]; then
            # JSON 페이로드 생성
            JSON_PAYLOAD="{\"postTitle\": \"${TITLE}\", \"postSummary\": \"${SUMMARY}\", \"postUrl\": \"${POST_URL}\", \"postCategory\": \"${CATEGORY}\""
            if [ -n "$THUMBNAIL_URL" ]; then
              JSON_PAYLOAD="${JSON_PAYLOAD}, \"postThumbnail\": \"${THUMBNAIL_URL}\""
            fi
            JSON_PAYLOAD="${JSON_PAYLOAD}}"

            curl -X POST "${AGENT_WEB_URL}/api/newsletter/send" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${NEWSLETTER_API_KEY}" \
              -d "$JSON_PAYLOAD"
          else
            echo "Could not extract title or summary from file"
          fi
